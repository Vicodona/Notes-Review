
[TOC]

## 背景

1、OSI（Open System Interconnect），即开放式系统互联。 一般都叫OSI参考模型，是ISO（国际标准化组织）组织在1985年研究的网络互联模型。 

2、TCP/IP协议栈是美国国防部高级研究计划局计算机网（ARPANET）和其后继因特网使用的参考模型。ARPANET是由美国国防部赞助的研究网络。最初，它只连接了美国境内的四所大学。随后的几年中，它通过租用的电话线连接了数百所大学和政府部门。最终ARPANET发展成为全球规模最大的互连网络-因特网。最初的ARPANET于1990年永久性地关闭。　　 

3、ISO制定的OSI参考模型的过于庞大、复杂招致了许多批评。与此对照，由技术人员自己开发的TCP/IP协议栈获得了更为广泛的应用。

## TCP/IP 参考模型

### 1 体系结构和主要协议

现在的Internet的主流协议族为 TCP/IP协议族，这是一个分层、多协议的通信体系。


<div align="center"> <img src="pics/TCP-IP/TCP-IP1.png" width="450"/> </div><br>

+ 上层协议使用下层协议所提供的服务，物理传输媒介可以当成网线。
+ 应用层如何与内核空间的传输层进行联系呢？是通过 socket 套接字来完成的。

物理链路层：网卡接口的网络驱动程序，处理数据在物理传输媒介上的传输。不同的物理网络具有不同的电器特性。网络驱动程序隐藏了这些细节，为上层协议提供了一个统一的接口。因为网卡不是只由一个生产商提供的。里面的内容包括它交换的数据格式也是不一样的，所以就需要这样一个驱动程序来充当翻译官的角色。

## 两个协议：ARP、RARP

ARP 协议：Address Resolve Protocol, 地址解析协议
RARP 协议：Reverse Address Resolve Protocol，逆地址协议
 
<div align="center"> <img src="pics/TCP-IP/TCP-IP2.png" width="450"/> </div><br>
 
这两个协议分别负责IP地址和物理地址的解析和逆解析。
 
<div align="center"> <img src="pics/TCP-IP/TCP-IP3.png" width="450"/> </div><br>
 
网络层是一个自下而上的协议，网络层是不可能直接连接主机的，需要通过数据链路层，但其沟通的语言不同，需要通过ARP进行翻译。网络层首先将IP地址从ARP来广播。知道主机的物理地址后数据链路层再通过物理地址来锁定这个主机。

网络层：数据包的选路和转发

 
<div align="center"> <img src="pics/TCP-IP/TCP-IP4.png" width="450"/> </div><br>
 
 现在的广域网WAN通常使用非常多的分级路由器，来进行连接分散的主机或者是局域网LAN。所以，通信的两台主机并不是直接连接的。而是通过非常非常多的中间节点。也就是路由器来控制的。网络层的任务就是选择这些中间的节点确定两台主机之间的通讯路径。网络层对上层协议也隐藏了这些网络的拓扑连接的细节。使得传输层和网络的应用程序来看，这两个又是直连的。
 
 网络层最核心的协议是IP协议。
 IP 协议(Internet Protocol,因特网协议)：根据数据包的目的IP地址决定如果投递信息
 
 根据数据包的目的和 IP 地址决定如何进行投递这个信息。如果数据没法直接发送给目标主机，那么IP协议就为它寻找合适的下一跳路由器。
 
 <div align="center"> <img src="pics/TCP-IP/TCP-IP5.png" width="450"/> </div><br>
   
 Ip协议通过**逐跳**的方式来确定通讯路径。然后将数据包交给该路由器进行转发。多次分重复这一过程，最终到达目标的主机或者由于发送失败而被丢弃。
   
 
 ICMP 协议(Internet Control Message Protocol,因特网控制报文协议)：检测网络连接
 
 ICMP 协议用于检测网络的连接，他是 IP 协议非常重要的补充。
 
  
 <div align="center"> <img src="pics/TCP-IP/TCP-IP6.png" width="450"/> </div><br>
 
+ 传输层为两台主机上的应用程序提供了端对端的通讯。
+ 传输层只关心通信的起始端和目的端，并不在乎数据包的中转过程。
+ 传输层为两台主机上的应用程序提供了端对端的通讯。

 <div align="center"> <img src="pics/TCP-IP/TCP-IP7.png" width="450"/> </div><br>

从这里可以看出数据链路层也就是驱动程序封装了物理网络的连接细节，网络层封装了网络连接的细节，传输层为应用程序封装了一条端对端的逻辑通信的链路，他负责收发还有链路的超时重连之类的。


传输层的协议主要有三个: TCP协议、UDP协议和SCTP协议

+ TCP协议(Transmission Control Protocol,传输控制协议)：为应用层提供可靠的、面向连接的、基于流（stream
的服务。

+ UDP协议(User Control Transmission Protocol, 用户数据协议)：为应用层提供不可靠、无连接、基于数据报的服务。

+ SCTP协议(Stream Control Transmission Protocol, 流控制传输协议)：为在因特网上传输电话信号而设计的服务。

TCP协议使用了**超时重传**数据确认的方式来确定数据包能正确发送到目的端，所以TCP服务是非常可靠的。通信的双方必须先建立TCP连接并在内核中保持维持连接的数据结构，比如连接的状态读写缓冲区还有定时器之类的。通讯结束的时候必须双方先关闭这些链接释放内核数据，它是基于流的，它的长度没有限制，源源不断的从通信的另一端流入另一端。

UDP协议则相反，提供了不可靠的服务。如果数据在中途丢失或者发现错误丢失的话，只是简单的通知应用程序而不进行数据确认和超时重传的这个任务。所以就需要用户或者程序员来自行的去判断这些东西。每个UDP的数据报都有一定的数据长度，接收端必须按照该长度为最小的单位将其所有的数据一次性的读出。否则数据将被截断。

应用层负责处理应用程序的逻辑，它的协议有非常非常的多。例如：

+ Ping 应用程序，利用ICMP报文检测网络连接

+ Telnet远程登录协议，在本地完成远程任务

+ OSPF(Open Shortest Path First, 开放最短路径优先)动态路由更新协议，用于路由器之间的通信

+ DNS(Domain Name Service, 域名服务)协议，提供机器域名到IP地址的转换功能。

说明：

+ 应用层协议可能跳过传输层从而直接使用网络层提供的服务
+ 应用层协议通常可以使用TCP服务，也可以使用UDP服务

## 封装
通过封装来使上层协议使用下层协议提供的服务。

<div align="center"> <img src="pics/TCP-IP/TCP-IP8.png" width="450"/> </div><br>

这个图片展示的过程即为封装。TCP报文也就是经过TCP封装后的数据。
